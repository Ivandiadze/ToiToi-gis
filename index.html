<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Toilet Map â€” PWA</title>
  <meta name="description" content="A progressive web app with an interactive map for adding restroom spots. Works offline, can be installed like an app." />

  <!-- PWA essentials -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#96a0ad; --text:#e9eef5; --accent:#2ec27e; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    #map{height:100%}
    /* Minimal styling for controls same as before */
  </style>
  <!-- PWA: manifest + theme color + iOS meta -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
</head>
<body>
  <div id="map"></div>

  <!-- Controls & panels same as previous version -->
  <!-- (For brevity: use the previous Leaflet implementation's controls and logic) -->

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.error('SW registration failed', err));
    }

    // Initialize map
    const map = L.map('map').setView([46.0569,14.5058],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,
      attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
  </script>
  
  <!-- PWA: service worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('./service-worker.js').catch(function(err){
          console.warn('SW registration failed:', err);
        });
      });
    }
  </script>

  <!-- === COPY-PASTE FILES FOR PWA (create them alongside index.html) ===

  1) manifest.json
  ------------------------------------------------------------------
  {
    "name": "Toilet Map",
    "short_name": "ToiletMap",
    "start_url": "./index.html",
    "scope": "./",
    "display": "standalone",
    "background_color": "#0b0f14",
    "theme_color": "#0b0f14",
    "icons": [
      { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
      { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png" },
      { "src": "icons/maskable-512.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
    ]
  }

  2) service-worker.js
  ------------------------------------------------------------------
  const CACHE_NAME = 'toilet-map-v1';
  const APP_SHELL = [
    './',
    './index.html',
    // icons
    './icons/icon-192.png',
    './icons/icon-512.png',
    './icons/icon-180.png',
  ];

  self.addEventListener('install', event => {
    event.waitUntil(
      caches.open(CACHE_NAME).then(cache => cache.addAll(APP_SHELL))
    );
    self.skipWaiting();
  });

  self.addEventListener('activate', event => {
    event.waitUntil(
      caches.keys().then(keys => Promise.all(keys.map(k => k === CACHE_NAME ? null : caches.delete(k))))
    );
    self.clients.claim();
  });

  // Cache-first for same-origin assets, network-first for others (Leaflet CDN, tiles)
  self.addEventListener('fetch', event => {
    const req = event.request;
    const url = new URL(req.url);

    if (url.origin === self.location.origin) {
      event.respondWith(
        caches.match(req).then(cached => cached || fetch(req).then(res => {
          const copy = res.clone();
          caches.open(CACHE_NAME).then(cache => cache.put(req, copy));
          return res;
        }))
      );
      return;
    }

    // For cross-origin (e.g., unpkg Leaflet, OSM tiles) use network-first with fallback
    event.respondWith(
      fetch(req).then(res => {
        const copy = res.clone();
        caches.open(CACHE_NAME).then(cache => cache.put(req, copy));
        return res;
      }).catch(() => caches.match(req))
    );
  });

  3) Icons (PNG)
  ------------------------------------------------------------------
  Place PNGs in /icons/ next to index.html:
  - icons/icon-180.png (for iOS Add to Home Screen)
  - icons/icon-192.png
  - icons/icon-512.png
  - icons/maskable-512.png (optional, looks better on Android)

  You can generate them from any square source image (512x512 recommended).
  === END COPY-PASTE FILES === -->

</body>
</html>
